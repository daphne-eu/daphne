<!--
Copyright 2022 The DAPHNE Consortium

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

## Integrating an accelerator API
This is a minimal bullet list of needed changes to integrate an external API/SDK. It follows the initial integration of CUDA and adapts these __steps by the example of OneAPI.__  
The changes can be grouped into three topics/areas: 
1. __General options/flags handling__ deals with compile and run time feature activation (e.g. handling of ```daphne --oneapi``` invocations)
2. __Daphne compiler integration__ This deals with introducing new operation types, attributes and traits to let the compiler know that there is a new type/variant of operation.
3. __Runtime kernels__ Here you implement the actual kernels and place the API specific calls. Adding more operations later on should mostly touch these parts.

Specific steps needed for certain hardware are not covered here. Like placing precompiled images somewhere.
Of particular importance for performance would be sophisticated memory management (e.g., integration with object metadata, context objects etc.).
This is also not covered in this introductory write-up.

### General flag/options handling and other setup

* __Compiler setup__ For OneAPI it is needed to source the setvars.sh script to set up the environment (pahts to compiler, includes, libraries): ```source /opt/intel/oneapi/setvars.sh```. The example uses the default install location. Sourcing this file is needed evey time you start working in a new shell.
* __Main CMakeLists.txt__
  - build switch for cmake invocation like "-DUSE_ONEAPI=ON"
  - separate invocation of cmake needed if compilers are changed for a language (e.g. the OneAPI integration changes the C++ compiler from g++ to dpcpp. Changing the compiler is not supported by CMake (other than setting it initially), so a separate invocation is required as can be seen in build.sh (at the end, after compiling main daphne))

* __Daphne Config Options__ use_api flag in DaphneUserConfig.h

* __daphne.cpp__ switch to use api or not

### Daphne/MLIR Compiler Parts

* #### src/compiler/execution/DaphneIrExecutor.cpp
  Introduce/create compiler pass (implemented separately)

  Load shared library (from the default output path)

* #### src/compiler/lowering/CMakeLists.txt
  Add source file containing compiler pass

* #### (new file) src/compiler/lowering/MarkONEAPIOpsPass.cpp
  Implementation of the compiler pass to select ops to be lowered.

  Check for trait and other requirements on the operation, then set an attribute to mark   the operation as eligible for lowering to the API specific kernels.

* #### src/compiler/lowering/RewriteLowerToCallKernelOps.cpp
  check for attribute, create appropriate kernel call name

* #### src/ir/daphneir/Daphne.h
  cpp source definition of APISupport trait

* #### src/ir/daphneir/DaphneOps.td
  add support trait in tablegen definition of the operation in question (matmul in this case)

* #### (new file) src/ir/daphneir/ONEAPISupport.td
  defines the operation trait in tablegen language

* #### src/ir/daphneir/Passes.h
  declare the create pass function

#### Runtime kernel parts:

* #### (new directory) src/runtime/local/kernels/ONEAPI
  place your API specific kernel files in a subdirectory

* #### (new file) src/runtime/local/kernels/ONEAPI/CMakeLists.txt
  Everything you need to compile the api specific Daphne kernelsj.
  Note the invocation of the genKernelInst.py python script. This needs the API name and the kernels.json file as input. 

* #### (new file) src/runtime/local/kernels/ONEAPI/MatMul.{h,cpp}
  The actual kernel implementation
* #### src/runtime/local/kernels/kernels.json
  The instantiations of the kernel templates are generated by the genKernelInst.py
  script with the help of the configuration in this file. Either add the API name to an existing specification of data types for instantiation, 
  or create a new API section (copy&paste from an existing one) if your implementation only supports a subset of the data types.

* #### Optional if needed: 
  - add subdirectory for precompiled binary images
  - add code to load/switch the images